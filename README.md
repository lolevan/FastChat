
# FastChat – Мини-приложение для чата

FastChat – это асинхронное приложение для обмена сообщениями, реализующее функционал чата с поддержкой групповых чатов. Приложение использует FastAPI для создания REST API и WebSocket‑подключений, PostgreSQL для хранения данных и SQLAlchemy (async) для работы с базой данных.

---

## Функциональные возможности

- **WebSocket‑чат:**
  - Подключение пользователей через WebSocket.
  - Обмен текстовыми сообщениями в реальном времени.
  - Возможность создания групповых чатов.
  - Сохранение сообщений в PostgreSQL с информацией:
    - ID сообщения
    - ID чата
    - ID отправителя
    - Текст сообщения
    - Время отправки
    - Признак прочитанного сообщения
  - Обработка статуса «прочитано»: отправитель получает уведомление, когда сообщение прочитано получателем или всеми участниками группы.
  - Предотвращение дублирования сообщений при параллельной отправке.

- **История сообщений:**
  - REST‑эндпоинт для получения истории сообщений по ID чата с пагинацией (параметры `limit` и `offset`).
  - Сообщения сортируются по времени отправки (по возрастанию).

- **Авторизация:**
  - JWT‑авторизация (OAuth2) для защиты эндпоинтов.

- **Поддержка подключения с нескольких устройств:**
  - Пользователь может быть подключен к чату с нескольких устройств одновременно.

- **Контейнеризация:**
  - Приложение упаковано в Docker-образ и может быть запущено с помощью Docker Compose.

- **Документация:**
  - Автоматическая документация API доступна через Swagger/OpenAPI.

---

## Технические требования

- **Backend:** FastAPI, asyncio, SQLAlchemy (async), PostgreSQL.
- **Контейнеризация:** Docker, Docker Compose.
- **Тестирование:** Pytest, pytest-asyncio.

---

## Запуск проекта через Docker

1. **Убедитесь, что установлен Docker и Docker Compose.**

2. **Склонируйте репозиторий и перейдите в корневую директорию проекта.**

3. **Запустите контейнеры:**

   ```bash
   docker-compose up --build
   ```

   Это запустит:
   - **db:** контейнер с PostgreSQL (порт 5432).
   - **app:** приложение FastAPI (порт 8000).

4. **Проверка работы API:**

   Откройте браузер и перейдите по адресу:
   
   ```
   http://localhost:8000/docs
   ```
   
   Здесь вы увидите Swagger UI с полной документацией по API.

---

## Примеры API-запросов

### Создание пользователя

**Запрос:**

```bash
curl -X POST "http://localhost:8000/users/" \
  -H "Content-Type: application/json" \
  -d '{"username": "john_doe", "email": "john@example.com", "password": "secret123"}'
```

**Ответ (пример):**

```json
{
  "id": 1,
  "username": "john_doe",
  "email": "john@example.com"
}
```

### Получение JWT-токена

**Запрос (форм-данные):**

```bash
curl -X POST "http://localhost:8000/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=john_doe&password=secret123"
```

**Ответ (пример):**

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### Создание группового чата

**Запрос:**

```bash
curl -X POST "http://localhost:8000/chats/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Team Chat", "user_ids": [1, 2]}'
```

**Ответ (пример):**

```json
{
  "id": 1,
  "name": "Team Chat",
  "type": "group"
}
```

### Получение истории сообщений

**Запрос:**

```bash
curl -X GET "http://localhost:8000/history/1?limit=50&offset=0"
```

**Ответ (пример):**

```json
[
  {
    "id": 1,
    "chat_id": 1,
    "sender_id": 1,
    "text": "Hello!",
    "created_at": "2025-03-10T12:00:00.000000",
    "is_read": false
  },
  {
    "id": 2,
    "chat_id": 1,
    "sender_id": 2,
    "text": "Hi there!",
    "created_at": "2025-03-10T12:01:00.000000",
    "is_read": true
  }
]
```

### Установка статуса "прочитано"

**Запрос:**

```bash
curl -X POST "http://localhost:8000/messages/1/read"
```

**Ответ (пример):**

```json
{
  "message": "Message marked as read"
}
```

---

## Работа с WebSocket

### Подключение к WebSocket

Подключитесь к WebSocket через клиент (например, [wscat](https://github.com/websockets/wscat) или [websocat](https://github.com/vi/websocat)):

```bash
wscat -c "ws://localhost:8000/ws/1?token=YOUR_JWT_TOKEN"
```

### Пример отправки сообщения

**Отправка текстового сообщения:**

```json
{"text": "Hello WebSocket"}
```

**Ответ (рассылка всем участникам):**

```json
{
  "id": 1,
  "chat_id": 1,
  "sender_id": 1,
  "text": "Hello WebSocket",
  "created_at": "2025-03-10T12:00:00.000000",
  "is_read": false
}
```

### Обработка статуса "прочитано" через WebSocket

Чтобы уведомить о прочтении, клиент отправляет событие:

```json
{"action": "read", "message_id": 1}
```

Сервер обновит статус сообщения и отправит уведомление всем участникам:

```json
{"action": "read_update", "message_id": 1, "is_read": true}
```

---

## Создание тестовых данных

Для быстрого создания тестовых данных можно использовать специальные curl-команды или написать скрипт. Пример команды для создания пользователя и чата:

1. **Создание двух пользователей:**

```bash
curl -X POST "http://localhost:8000/users/" \
  -H "Content-Type: application/json" \
  -d '{"username": "user1", "email": "user1@example.com", "password": "password1"}'

curl -X POST "http://localhost:8000/users/" \
  -H "Content-Type: application/json" \
  -d '{"username": "user2", "email": "user2@example.com", "password": "password2"}'
```

2. **Создание группового чата:**

```bash
curl -X POST "http://localhost:8000/chats/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test Chat", "user_ids": [1, 2]}'
```

3. **Отправка сообщения через WebSocket:**  
   Подключитесь через WebSocket-клиент, как описано выше, и отправьте сообщение.

---

## Запуск тестов

Автоматизированные тесты написаны с использованием pytest и pytest-asyncio. Чтобы запустить тесты, выполните:

```bash
pytest
```

Тесты проверяют:
- Создание пользователя и получение JWT-токена.
- Создание группового чата.
- Получение истории сообщений.
- Установку статуса "прочитано" для сообщений.

---

## Задачи, выполненные в проекте

1. **WebSocket чат:**
   - Реализовано подключение через WebSocket.
   - Обмен сообщениями в реальном времени.
   - Предотвращение дублирования сообщений.
   - Обработка статуса "прочитано" с уведомлением отправителя.

2. **Групповые чаты:**
   - Создание групповых чатов с указанием списка участников.
   - Хранение информации о типе чата и создателе.

3. **История сообщений:**
   - REST‑эндпоинт для получения истории сообщений с пагинацией и сортировкой по времени.

4. **Безопасность:**
   - JWT‑авторизация через OAuth2.
   - Защита эндпоинтов с помощью Depends.

5. **Контейнеризация:**
   - Приложение и база данных упакованы в Docker-образы.
   - Использование Docker Compose для удобного развертывания.

6. **Тестирование:**
   - Юнит‑тесты с использованием pytest и pytest-asyncio.
   - Автоматизированное тестирование основных сценариев работы приложения.

---

## Заключение

FastChat реализует весь функционал, требуемый в техническом задании:
- Чат с WebSocket‑подключением.
- Хранение сообщений в PostgreSQL.
- Групповые чаты и история сообщений.
- Обработка статуса "прочитано" и предотвращение дублирования сообщений.
- JWT‑авторизация и поддержка подключения с нескольких устройств.

Запустите приложение через Docker, протестируйте API через Swagger UI и WebSocket‑клиент, а также запустите автоматизированные тесты командой `pytest` для проверки корректной работы всех компонентов.
